stages:
  - build
  - deploy

# Friend 3's jobs (already there - DON'T TOUCH)
# ... their existing jobs ...

# YOUR JOBS - ADD THESE:

build-task-manager-backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - cd apps/task-manager/backend
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker build -t xilv2/aks-backend:$CI_COMMIT_SHORT_SHA .
    - docker build -t xilv2/aks-backend:latest .
    - docker push xilv2/aks-backend:$CI_COMMIT_SHORT_SHA
    - docker push xilv2/aks-backend:latest
  only:
    changes:
      - apps/task-manager/backend/**/*

build-task-manager-frontend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - cd apps/task-manager/frontend
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker build -t xilv2/aks-frontend:$CI_COMMIT_SHORT_SHA .
    - docker build -t xilv2/aks-frontend:latest .
    - docker push xilv2/aks-frontend:$CI_COMMIT_SHORT_SHA
    - docker push xilv2/aks-frontend:latest
  only:
    changes:
      - apps/task-manager/frontend/**/*

deploy-task-manager:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl apply -f apps/task-manager/k8s/
  only:
    changes:
      - apps/task-manager/**/*
